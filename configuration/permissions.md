# ğŸ”’ æƒé™ç³»ç»Ÿ

æœ¬æ–‡å¯¹åº”å½“å‰å®ç°çš„ `PermissionChecker` / `ExecutionPipeline`ï¼Œæè¿° allow/ask/deny è§„åˆ™ã€æƒé™æ¨¡å¼ä»¥åŠç¡®è®¤æŒä¹…åŒ–è¡Œä¸ºã€‚

## æƒé™çº§åˆ«ä¸åŒ¹é…

- `allow`ï¼šè‡ªåŠ¨å…è®¸æ‰§è¡Œã€‚
- `ask`ï¼šéœ€è¦ç”¨æˆ·ç¡®è®¤ã€‚
- `deny`ï¼šç›´æ¥æ‹’ç»ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ã€‚

åŒ¹é…é¡ºåºï¼š`deny` > `allow` > `ask` > é»˜è®¤ï¼ˆaskï¼‰ã€‚è§„åˆ™é€šè¿‡ `picomatch` æ”¯æŒç²¾ç¡®ã€å‰ç¼€ã€`*`/`**` é€šé…å’Œå¸¦å‚æ•°çš„ globï¼š

```json
{
  "permissions": {
    "allow": [
      "Read(file_path:**/*.ts)",
      "Grep"
    ],
    "deny": [
      "Read(file_path:**/.env*)",
      "Bash(rm -rf *)"
    ]
  }
}
```

ç­¾åæ ¼å¼ï¼š`Tool(param1:value1, param2:value2)`ï¼›`*` / `**` å¯åŒ¹é…ä»»æ„å†…å®¹ï¼Œå‚æ•°å€¼åŒæ ·æ”¯æŒ globã€‚

## æƒé™æ¨¡å¼

æƒé™æ¨¡å¼åœ¨æƒé™é˜¶æ®µå¼ºåˆ¶è¦†ç›–ç»“æœï¼š

| æ¨¡å¼ | è‡ªåŠ¨å…è®¸ | æ‹’ç» | è¯´æ˜ |
| --- | --- | --- | --- |
| `default` | æ‰€æœ‰åªè¯»å·¥å…· | - | åªè¯»å·¥å…·ï¼ˆReadã€Globã€Grepã€WebFetchã€WebSearchã€BashOutputã€TodoWriteã€Plan å·¥å…·ã€Taskï¼‰ç›´æ¥é€šè¿‡ã€‚ |
| `autoEdit` | åªè¯» + Write ç±»å·¥å…·ï¼ˆEdit/Write/NotebookEditï¼‰ | - | é€‚åˆé¢‘ç¹æ”¹æ–‡ä»¶ã€‚ |
| `yolo` | æ‰€æœ‰å·¥å…· | - | è·³è¿‡æ‰€æœ‰ç¡®è®¤ï¼Œéœ€è‡ªæ‹…é£é™©ã€‚ |
| `plan` | åªè¯»å·¥å…· | å…¶ä»–å…¨éƒ¨æ‹’ç» | é€‚åˆè°ƒç ”/æ–¹æ¡ˆé˜¶æ®µï¼Œå¿…é¡»ç”¨ ExitPlanMode æäº¤æ–¹æ¡ˆåå†åˆ‡æ¢æ¨¡å¼ã€‚ |
| `spec` | åªè¯»å·¥å…· + Spec ç›¸å…³å·¥å…· | - | è§„æ ¼é©±åŠ¨å¼€å‘æ¨¡å¼ï¼Œæ”¯æŒç»“æ„åŒ–çš„éœ€æ±‚åˆ†æå’Œä»»åŠ¡ç®¡ç†ã€‚Spec å·¥å…·ï¼ˆUpdateSpecã€AddTask ç­‰ï¼‰è‡ªåŠ¨å…è®¸ã€‚ |

> UI ä¸­ `Shift+Tab` å¾ªç¯ `default â†’ autoEdit â†’ plan â†’ spec`ï¼Œ`yolo` éœ€é€šè¿‡ CLI/é…ç½®è®¾ç½®ã€‚

## ç¡®è®¤ä¸æŒä¹…åŒ–

- å½“è§„åˆ™åˆ¤å®šä¸º `ask` æ—¶ï¼Œ`ConfirmationStage` ä¼šè°ƒç”¨ UI çš„ç¡®è®¤å¼¹çª—ã€‚
- é€‰æ‹©â€œä¼šè¯å†…è®°ä½â€ä¼šæŠŠæŠ½è±¡åçš„è§„åˆ™å†™å…¥ `.blade/settings.local.json`ï¼Œç«‹å³åˆ·æ–°å†…å­˜é…ç½®ï¼Œåç»­åŒç±»æ“ä½œä¸å†å¼¹çª—ã€‚
- **è½®æ¬¡ä¸Šé™ç¡®è®¤**ï¼šå½“ LLM å“åº”è½®æ¬¡è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 100 è½®ï¼‰æ—¶ï¼Œä¹Ÿä¼šè§¦å‘ç¡®è®¤å¼¹çª—ã€‚ç”¨æˆ·é€‰æ‹©â€œç»§ç»­â€å¯é‡ç½®è®¡æ•°å™¨ï¼Œé€‰æ‹©â€œåœæ­¢â€åˆ™ç»ˆæ­¢ä»»åŠ¡ã€‚
- æŠ½è±¡é€»è¾‘ç”±å„å·¥å…·çš„ `abstractPermissionRule` æä¾›ï¼Œä¾‹å¦‚ï¼š
  - Bashï¼šæå–ä¸»å‘½ä»¤ï¼Œè®°ä¸º `Bash(command:npm *)` ç­‰ï¼›
  - Edit/Writeï¼šåŸºäº `file_path` ç”Ÿæˆ `Edit(file_path:**/*.ts)`ï¼›
  - WebFetch/WebSearchï¼šç”ŸæˆåŸŸåçº§æˆ– `search:*` è§„åˆ™ï¼›
  - Task/SlashCommand è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆä¸è‡ªåŠ¨ç”Ÿæˆè§„åˆ™ï¼‰ã€‚

## é…ç½®ä½ç½®

è¡Œä¸ºé…ç½®å­˜æ”¾åœ¨ `settings.json` / `settings.local.json`ï¼ˆåŠ è½½é¡ºåºè§é…ç½®ç³»ç»Ÿç« èŠ‚ï¼‰ï¼Œç¤ºä¾‹ï¼š

```json
{
  "permissionMode": "default",
  "permissions": {
    "allow": [
      "Bash(git status*)",
      "Read(file_path:**/*.md)"
    ],
    "ask": [
      "Write",
      "Edit"
    ],
    "deny": [
      "Read(file_path:**/.env*)",
      "Bash(sudo *)"
    ]
  }
}
```

## æœ€ä½³å®è·µ

- **ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶**ï¼š`Read(file_path:**/.env*)`ã€`Read(file_path:**/*.pem)`ã€‚
- **é™åˆ¶å±é™©å‘½ä»¤**ï¼š`Bash(rm -rf *)`ã€`Bash(sudo *)`ã€‚
- **æŒ‰æ–‡ä»¶ç±»å‹æ”¾è¡Œè¯»å–**ï¼š`Read(file_path:**/*.{ts,tsx,js,jsx,md,json})`ã€‚
- **æŒ‰å‘½ä»¤æ—æ”¾è¡Œ**ï¼š`Bash(git *)`ã€`Bash(npm run *)`ã€‚
- ä½¿ç”¨ `settings.local.json` å­˜æ”¾ä¸ªäººä¿¡ä»»è§„åˆ™ï¼Œé¿å…æäº¤åˆ°ä»“åº“ã€‚

## ç›¸å…³ä»£ç 

- æƒé™åˆ¤å®šï¼š`src/config/PermissionChecker.ts`
- æ¨¡å¼è¦†ç›–ä¸ç¡®è®¤ï¼š`src/tools/execution/PipelineStages.ts`
- é»˜è®¤è§„åˆ™ä¸æ¨¡å¼æšä¸¾ï¼š`src/config/defaults.ts`ã€`src/config/types.ts`
- è‡ªåŠ¨è½ç›˜ï¼š`configActions().appendLocalPermissionAllowRule`ï¼ˆç”±ç¡®è®¤é˜¶æ®µè°ƒç”¨ï¼‰
